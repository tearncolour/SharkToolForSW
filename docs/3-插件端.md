# 3. 插件端 (SolidWorks Add-in)

## 3.1 项目结构

```
sharktools/
|-- Connect.cs                  # Add-in 入口点，ISwAddin 实现
|-- SharkCommandManager.cs      # 命令管理器，创建工具栏和菜单
|-- ElectronServer.cs           # WebSocket 通信客户端
|-- EnhancedHistoryTracker.cs   # 增强历史记录追踪器
|-- HistoryTracker.cs           # 基础历史记录追踪器
|-- HistoryDatabase.cs          # LiteDB 数据库管理
|-- HistoryRecord.cs            # 历史记录数据模型
|-- CustomPropertyManager.cs    # 自定义属性管理
|-- BatchRenameManager.cs       # 批量重命名管理
|-- ProjectManager.cs           # 项目文件夹管理
|-- FileCompareManager.cs       # 文件对比管理
|-- ModelConverter.cs           # 模型格式转换器
|-- ThumbnailHelper.cs          # 缩略图提取工具
|-- PerformanceOptimizer.cs     # 性能优化与弹窗拦截
|-- GitHubAuth.cs               # GitHub OAuth 认证
|-- Properties/
|   |-- AssemblyInfo.cs         # 程序集信息与 COM GUID
|-- SharkTools.csproj           # 项目文件
|-- SharkTools.snk              # 强名称签名密钥
```

## 3.2 核心类说明

### 3.2.1 Connect.cs

Add-in 入口类，实现 `ISwAddin` 接口。

```csharp
[ComVisible(true)]
[Guid("D7FFFFFF-9FFF-FFF7-8FFA-5A7F6C26FFFF")]
public class Connect : ISwAddin
{
    public bool ConnectToSW(object ThisSW, int Cookie);
    public bool DisconnectFromSW();
}
```

**职责**：
- 初始化 SolidWorks API 连接
- 创建 `SharkCommandManager` 和 `ElectronServer`
- 初始化历史数据库
- 启动性能监控和弹窗拦截器

### 3.2.2 SharkCommandManager.cs

命令和 UI 管理器。

**功能**：
- 创建 SolidWorks 工具栏按钮
- 创建 CommandTab（标签页）
- 创建 TaskPane（任务窗格）
- 管理命令回调

**命令列表**：
| 命令 | 回调方法 | 说明 |
|------|----------|------|
| 打招呼 | SharkHello | 显示问候消息 |
| 登录 GitHub | GitHubLogin | OAuth 登录 |
| 启动工具箱 | LaunchElectronApp | 启动 Electron 客户端 |
| 资源诊断 | DiagnoseResources | 分析资源使用 |
| 清理优化 | CleanupResources | 内存清理 |
| 神奇妙妙工具 | 

### 3.2.3 ElectronServer.cs

WebSocket 通信客户端，处理与 Electron 的双向通信。

**主要方法**：

```csharp
public class ElectronServer
{
    // 启动连接
    public void Start();
    
    // 停止连接
    public void Stop();
    
    // 发送消息
    private void Send(string data);
    
    // 处理命令
    private async Task<string> HandleCommandAsync(string jsonBody);
    
    // UI 线程执行
    private Task RunOnUIThread(Action action);
}
```

**支持的命令**：

| 命令 | 说明 |
|------|------|
| ping | 心跳检测 |
| open | 打开文档 |
| get_active | 获取当前文档信息 |
| load-history | 加载历史记录 |
| create-file | 创建新文档 |
| get-thumbnail | 获取缩略图 |
| get-properties | 获取文档属性 |
| convert-and-recognize | 转换 STEP/IGES 文件 |
| get-custom-properties | 获取自定义属性 |
| set-custom-property | 设置单个属性 |
| set-custom-properties-batch | 批量设置属性 |
| delete-custom-property | 删除属性 |
| preview-rename | 预览重命名结果 |
| execute-rename | 执行批量重命名 |
| create-project | 创建项目 |
| delete-project | 删除项目 |
| compare-files | 对比两个文件 |

### 3.2.4 EnhancedHistoryTracker.cs

增强历史记录追踪器，使用定时监控检测特征变化。

**功能**：
- 定时（1.5秒）检测特征树变化
- 记录特征的添加/删除/修改
- 支持文档快照和回滚
- Git 风格的对比功能
- 高压缩存储历史数据

**核心数据结构**：

```csharp
public class FeatureSnapshot
{
    public string Name { get; set; }
    public string TypeName { get; set; }
    public bool IsSuppressed { get; set; }
    public string Parameters { get; set; }  // JSON 序列化的参数
}

public class DocumentSnapshot
{
    public string Id { get; set; }
    public string Description { get; set; }
    public DateTime Timestamp { get; set; }
    public List<FeatureSnapshot> Features { get; set; }
    public byte[] CompressedData { get; set; }  // GZip 压缩
}
```

### 3.2.5 SwCustomPropertyManager.cs

SolidWorks 文件自定义属性管理器。

**方法**：

```csharp
public class SwCustomPropertyManager
{
    // 获取所有自定义属性
    Task<CustomPropertyResult> GetCustomProperties(string filePath, string configName = "");
    
    // 设置单个属性
    Task<OperationResult> SetCustomProperty(string filePath, string propertyName, 
                                             string propertyValue, string configName = "");
    
    // 批量设置属性
    Task<BatchOperationResult> SetCustomPropertiesBatch(string filePath, 
                                                         Dictionary<string, string> properties,
                                                         string configName = "");
    
    // 多文件批量设置
    Task<object> SetCustomPropertiesMultipleFiles(List<string> filePaths,
                                                   Dictionary<string, string> properties,
                                                   string configName = "");
    
    // 删除属性
    Task<OperationResult> DeleteCustomProperty(string filePath, string propertyName,
                                                string configName = "");
}
```

**预定义属性模板**：
- ProjectName (项目名称)
- Owner (负责人)
- Version (版本号)
- PartType (零件类型)
- ManufacturingProcess (制作工艺)
- Material (材料)
- Weight (重量)
- Description (描述)
- Supplier (供应商)
- Cost (成本)
- CreateDate (创建日期)
- ModifyDate (修改日期)

### 3.2.6 BatchRenameManager.cs

批量重命名管理器，支持多种命名模板。

**命名模板**：

| 模板ID | 名称 | 格式 |
|--------|------|------|
| ProjectPartVersion | 项目+零件类型+版本号 | {ProjectName}_{PartType}_{Version} |
| OwnerDate | 负责人+日期 | {Owner}_{Date} |
| Prefix | 添加前缀 | {Prefix}{OriginalName} |
| Suffix | 添加后缀 | {OriginalName}{Suffix} |
| Replace | 查找替换 | {Replace} |
| Sequential | 顺序编号 | {BaseName}_{Number:000} |
| Custom | 自定义规则 | {Custom} |

**可用变量**：
- {OriginalName} - 原文件名
- {ProjectName} - 项目名称（从自定义属性读取）
- {Owner} - 负责人
- {Version} - 版本号
- {PartType} - 零件类型
- {Date} - 日期 (YYYYMMDD)
- {DateTime} - 日期时间 (YYYYMMDD_HHmmss)
- {Number} / {Number:000} - 顺序编号
- {Material} - 材料
- {Description} - 描述

### 3.2.7 ProjectManager.cs

项目文件夹管理器。

**功能**：
- 创建项目（含子文件夹结构）
- 删除/重命名项目
- 获取项目列表和统计信息
- 移动/复制文件到项目
- 导入现有文件夹为项目
- 项目模板管理

**默认项目结构**：
```
项目名称/
|-- 零件/
|-- 装配体/
|-- 工程图/
|-- 参考资料/
|-- 导出/
|-- .sharkproject (项目配置文件)
```

### 3.2.8 FileCompareManager.cs

文件对比管理器，比较两个 SolidWorks 文件的差异。

**对比维度**：
- 自定义属性差异
- 特征树差异（添加/删除/修改）
- 几何信息差异（体积、表面积、质心等）
- 配置差异

**返回数据结构**：

```csharp
public class CompareResult
{
    public bool Success { get; set; }
    public string File1Path { get; set; }
    public string File2Path { get; set; }
    public DocumentCompareInfo File1Info { get; set; }
    public DocumentCompareInfo File2Info { get; set; }
    public List<PropertyDiff> PropertyDiffs { get; set; }
    public List<CompareFeatureDiff> FeatureDiffs { get; set; }
    public GeometryDiff GeometryDiffs { get; set; }
    public List<ConfigurationDiff> ConfigurationDiffs { get; set; }
}
```

### 3.2.9 ModelConverter.cs

模型格式转换器，支持将 STEP/IGES 文件转换为 SLDPRT。

**特性**：
- 静默模式导入（不弹出对话框）
- 自动保存为原生格式
- 支持特征识别（可选）
- 转换完成后自动关闭临时文档

### 3.3 依赖项

**NuGet 包**：
- Newtonsoft.Json - JSON 序列化
- LiteDB - 嵌入式 NoSQL 数据库
- WebSocketSharp - WebSocket 客户端

**SolidWorks API 引用**：
- SolidWorks.Interop.sldworks.dll
- SolidWorks.Interop.swconst.dll
- SolidWorks.Interop.swpublished.dll
- SolidWorks.Interop.fworks.dll (FloWorks API)