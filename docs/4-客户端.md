# 4. 客户端 (Electron 应用)

## 4.1 项目结构

```
electron-app/
|-- main.js                 # Electron 主进程
|-- preload.js              # 预加载脚本（安全桥接）
|-- package.json            # 项目配置
|-- vite.config.js          # Vite 构建配置
|-- renderer/
|   |-- index.html          # 入口 HTML
|   |-- main.js             # Vue 入口
|   |-- App.vue             # 根组件
|   |-- styles.css          # 全局样式
|   |-- components/
|       |-- FileExplorer.vue      # 文件资源管理器
|       |-- HistoryPanel.vue      # 历史记录面板
|       |-- HistoryDiffViewer.vue # 历史对比查看器
|       |-- GitPanel.vue          # Git 版本控制面板
|       |-- PreviewPanel.vue      # 文件预览面板
|       |-- SettingsPanel.vue     # 设置面板
|       |-- PropertyPanel.vue     # 自定义属性面板
|       |-- RenamePanel.vue       # 批量重命名面板
|       |-- ComparePanel.vue      # 文件对比面板
|       |-- PdfViewer.vue         # PDF 查看器
|       |-- TextEditor.vue        # 文本编辑器
|-- workers/
|   |-- occt-worker.js      # OpenCASCADE 3D 处理 Worker
|-- assets/
    |-- icon.png            # 应用图标
    |-- tray-icon.png       # 托盘图标
```

## 4.2 主进程 (main.js)

### 4.2.1 窗口管理

```javascript
// 创建主窗口
function createWindow() {
    mainWindow = new BrowserWindow({
        width: 1200,
        height: 800,
        frame: false,           // 无边框窗口
        webPreferences: {
            nodeIntegration: false,
            contextIsolation: true,
            preload: path.join(__dirname, 'preload.js')
        }
    });
}

// 系统托盘
function createTray() {
    tray = new Tray(iconPath);
    tray.setContextMenu(contextMenu);
}
```

### 4.2.2 WebSocket 服务器

```javascript
const WS_PORT = 52789;

function startWebSocketServer() {
    wss = new WebSocket.Server({ 
        port: WS_PORT, 
        host: '127.0.0.1' 
    });
    
    wss.on('connection', (ws) => {
        swWebSocket = ws;
        isConnected = true;
        
        ws.on('message', (message) => {
            handleSolidWorksMessage(JSON.parse(message));
        });
    });
}
```

### 4.2.3 IPC 处理程序

主要 IPC 通道：

| 通道 | 方向 | 说明 |
|------|------|------|
| sw-command | renderer -> main | 发送命令到 SolidWorks |
| sw-message | main -> renderer | 接收 SolidWorks 消息 |
| launch-solidworks | renderer -> main | 启动 SolidWorks |
| read-directory | renderer -> main | 读取目录内容 |
| get-thumbnail | renderer -> main | 获取文件缩略图 |
| git-* | renderer -> main | Git 操作相关 |
| open-file-dialog | renderer -> main | 打开文件选择对话框 |

## 4.3 渲染进程 (Vue 组件)

### 4.3.1 App.vue

根组件，实现 VSCode 风格的布局。

**布局结构**：
```
+----------------------------------------------------------+
| 标题栏 (titlebar)                                         |
+------+------------+--------------------------------------+
| 活动 | 侧边栏     | 编辑区                               |
| 栏   | (资源管理/ | (状态栏 + 预览面板)                   |
|      | Git/历史) |                                       |
+------+------------+--------------------------------------+
```

**状态管理**：
```javascript
const currentView = ref('explorer');     // 当前视图
const sidebarCollapsed = ref(false);     // 侧边栏折叠状态
const connectionStatus = ref('default'); // 连接状态
const currentDocument = reactive({});    // 当前文档信息
const historyRecords = ref([]);          // 历史记录
```

### 4.3.2 FileExplorer.vue

文件资源管理器组件。

**功能**：
- 树形目录结构显示
- SolidWorks 文件缩略图预览
- 右键上下文菜单
- 文件搜索过滤
- 拖放支持
- 双击在 SolidWorks 中打开

**文件类型图标**：
```javascript
const fileIcons = {
    '.sldprt': { icon: PartIcon, color: '#4fc3f7' },
    '.sldasm': { icon: AssemblyIcon, color: '#81c784' },
    '.slddrw': { icon: DrawingIcon, color: '#ffb74d' },
    '.step': { icon: StepIcon, color: '#ce93d8' },
    '.pdf': { icon: PdfIcon, color: '#ef5350' }
};
```

### 4.3.3 HistoryPanel.vue

历史记录面板组件。

**功能**：
- 显示特征操作历史
- 支持回滚到指定版本
- 删除历史记录
- 标记重要记录
- 添加标签和注释

### 4.3.4 GitPanel.vue

Git 版本控制面板。

**功能**：
- 显示仓库状态
- 文件暂存/取消暂存
- 提交更改
- 分支管理
- 查看提交历史

### 4.3.5 PropertyPanel.vue

自定义属性管理面板。

**功能**：
- 显示文件自定义属性列表
- 编辑属性值
- 添加/删除属性
- 使用预定义模板
- 批量设置多个文件

### 4.3.6 RenamePanel.vue

批量重命名面板。

**功能**：
- 选择重命名模板
- 预览重命名结果
- 检测文件名冲突
- 执行批量重命名
- 支持更新引用

### 4.3.7 ComparePanel.vue

文件对比面板。

**功能**：
- 选择两个文件进行对比
- 显示属性差异（表格形式）
- 显示特征差异（颜色编码）
- 显示几何信息差异
- 并排对比视图

### 4.3.8 PreviewPanel.vue

文件预览面板组件。

**功能**：
- 支持多种文件类型预览
- PDF 文件预览
- 图片预览
- 文本文件预览
- 3D 模型预览（STEP/IGES）

### 4.3.9 GlobalSearchReplace.vue

全局搜索替换组件。

**功能**：
- 在整个项目中搜索文件名
- 支持正则表达式和普通文本搜索
- 区分大小写选项
- 显示所有匹配文件
- 一键全部替换
- 点击结果直接定位文件

### 4.3.10 ProjectManagerPanel.vue

项目管理器面板组件。

**功能**：
- 创建和管理项目
- 导入现有文件夹为项目
- 查看项目统计信息
- 管理项目模板

### 4.3.11 NamingTemplateBuilder.vue

可视化命名模板构建器组件。

**功能**：
- 拖拽式组件构建命名模板
- 支持多种组件类型（前缀、后缀、序号、日期、作者、原文件名等）
- 实时预览命名效果
- 支持批量应用命名规则
- 可自由调整组件顺序
- 支持序号配置（起始值和位数）

### 4.3.12 QuickMaterialModal.vue

快速材料设置模态框组件。

**功能**：
- 快速设置零件材料
- 显示当前材料信息
- 支持材料数据库管理
- 批量应用材料

### 4.3.13 SettingsPanel.vue

设置面板组件。

**功能**：
- 应用设置管理
- 主题切换
- 快捷键设置
- 插件配置

### 4.3.14 TextEditor.vue

文本编辑器组件。

**功能**：
- 文本文件编辑
- 代码高亮
- 语法检查
- 保存和撤销功能

### 4.3.15 VirtualFileExplorer.vue

虚拟文件资源管理器组件。

**功能**：
- 基于虚拟文件夹的文件管理
- 支持虚拟文件夹的创建和管理
- 支持命名规则的应用
- 批量文件操作

### 4.3.16 CreateProjectModal.vue

创建项目模态框组件。

**功能**：
- 项目基本信息填写
- 项目模板选择
- 项目路径设置
- 项目结构预览

### 4.3.17 FileIcon.vue

文件图标组件。

**功能**：
- 根据文件扩展名显示不同图标
- 支持 SolidWorks 文件类型
- 支持常见办公文件类型
- 支持自定义图标映射

### 4.3.18 HistoryDiffViewer.vue

历史差异查看器组件。

**功能**：
- 显示两个历史快照之间的差异
- 支持特征级别的差异对比
- 可视化显示添加/删除/修改的特征
- 提供回滚选项

## 4.4 3D 预览

使用 Three.js 和 occt-import-js 实现 STEP/IGES 文件的 3D 预览。

```javascript
// Web Worker 中处理 3D 文件
importScripts('occt-import-js.js');

onmessage = async function(e) {
    const { fileBuffer, fileName } = e.data;
    const result = await occtImport.ImportStep(fileBuffer);
    postMessage(result);
};
```

## 4.5 依赖包

```json
{
  "dependencies": {
    "ant-design-vue": "^4.2.6",      // UI 组件库
    "@ant-design/icons-vue": "^7.0.1", // 图标
    "vue": "^3.5.25",                 // Vue 3
    "electron-store": "^8.1.0",       // 持久化存储
    "simple-git": "^3.30.0",          // Git 操作
    "three": "^0.182.0",              // 3D 渲染
    "occt-import-js": "^0.0.23",      // STEP/IGES 导入
    "pdfjs-dist": "^4.0.379",         // PDF 渲染
    "xlsx": "^0.18.5",                // Excel 解析
    "highlight.js": "^11.11.1",       // 代码高亮
    "ws": "^8.18.3"                   // WebSocket
  }
}
```