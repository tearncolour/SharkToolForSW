# 6. 功能模块

## 6.1 历史记录追踪

**工作流程**：
1. 文档打开时，EnhancedHistoryTracker 开始追踪
2. 定时器（1.5秒间隔）检测特征树变化
3. 发现变化时创建 FeatureChangeRecord
4. 触发相应事件（OnFeatureAdded/Deleted/Modified）
5. 记录保存到 LiteDB 数据库
6. 通过 WebSocket 推送到 Electron 客户端

**回滚机制**：
1. 用户选择历史快照
2. 调用 RollbackToSnapshot 方法
3. 压制当前所有特征
4. 按顺序恢复快照中的特征

## 6.2 文件转换

**STEP 转 SLDPRT 流程**：
1. 接收转换请求（文件路径）
2. 使用 LoadFile4 静默导入 STEP 文件
3. 使用 SaveAs3 保存为 SLDPRT 格式
4. 关闭临时文档（保留用户原有文档）
5. 返回转换结果

## 6.3 缩略图提取

**方法**：
1. 使用 Shell32 COM 接口提取嵌入缩略图
2. 转换为 Base64 编码的 PNG 图片
3. 缓存到内存避免重复提取