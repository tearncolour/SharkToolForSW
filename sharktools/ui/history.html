<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharkTools å†å²è®°å½•</title>
    <link rel="stylesheet" href="history.css">
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="header">
            <button class="back-button" @click="goBack">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M19 12H5M12 19l-7-7 7-7" stroke-width="2" stroke-linecap="round"/>
                </svg>
                è¿”å›ä¸»ç•Œé¢
            </button>
            <h1 class="title">å†å²è®°å½•</h1>
        </div>

        <!-- æ–‡æ¡£ä¿¡æ¯å¡ç‰‡ -->
        <div class="doc-info" v-if="documentInfo.name">
            <div class="doc-icon">ğŸ“„</div>
            <div class="doc-details">
                <div class="doc-name">{{ documentInfo.name }}</div>
                <div class="doc-path">{{ documentInfo.path }}</div>
                <div class="doc-stats">
                    å…± {{ records.length }} æ¡è®°å½• Â· æœ€åæ›´æ–° {{ lastUpdated }}
                </div>
            </div>
        </div>

        <!-- åˆ†æ”¯é€‰æ‹©å™¨ -->
        <div class="branch-selector">
            <div class="branch-current" @click="toggleBranchMenu">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="6" y1="3" x2="6" y2="15" stroke-width="2"/>
                    <circle cx="18" cy="6" r="3" stroke-width="2"/>
                    <circle cx="6" cy="18" r="3" stroke-width="2"/>
                    <path d="M18 9a9 9 0 0 1-9 9" stroke-width="2"/>
                </svg>
                <span>{{ currentBranch }}</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="branch-menu" v-show="showBranchMenu">
                <div class="branch-list">
                    <div 
                        v-for="branch in branches" 
                        :key="branch.name"
                        class="branch-item"
                        :class="{ 'active': branch.name === currentBranch }"
                        @click="switchBranch(branch.name)"
                    >
                        <span class="branch-name">{{ branch.name }}</span>
                        <span class="branch-desc">{{ branch.description }}</span>
                        <button 
                            v-if="branch.name !== 'main'" 
                            class="branch-delete" 
                            @click.stop="deleteBranch(branch.name)"
                            title="åˆ é™¤åˆ†æ”¯"
                        >ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="branch-actions">
                    <button class="branch-new-btn" @click="showNewBranchDialog">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <line x1="12" y1="5" x2="12" y2="19" stroke-width="2" stroke-linecap="round"/>
                            <line x1="5" y1="12" x2="19" y2="12" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        æ–°å»ºåˆ†æ”¯
                    </button>
                </div>
            </div>
        </div>

        <!-- å›æº¯çŠ¶æ€æç¤º -->
        <div class="rollback-status" v-if="currentRollbackId">
            <div class="rollback-info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="10" stroke-width="2"/>
                    <path d="M12 6v6l4 2" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>å½“å‰å¤„äºå†å²å›æº¯çŠ¶æ€ï¼Œéƒ¨åˆ†ç‰¹å¾å·²è¢«æŠ‘åˆ¶</span>
            </div>
            <button class="restore-latest-btn" @click="restoreToLatest">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M3 12a9 9 0 0114.5-7M21 12a9 9 0 01-14.5 7M3 4v5h5M21 20v-5h-5" stroke-width="2" stroke-linecap="round"/>
                </svg>
                æ¢å¤åˆ°æœ€æ–°
            </button>
        </div>

        <!-- æ–°å»ºåˆ†æ”¯å¯¹è¯æ¡† -->
        <div class="modal-overlay" v-show="showNewBranch" @click.self="showNewBranch = false">
            <div class="modal-content">
                <h3>æ–°å»ºåˆ†æ”¯</h3>
                <div class="form-group">
                    <label>åˆ†æ”¯åç§°</label>
                    <input type="text" v-model="newBranchName" placeholder="è¾“å…¥åˆ†æ”¯åç§°">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <input type="text" v-model="newBranchDesc" placeholder="å¯é€‰æè¿°">
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" @click="showNewBranch = false">å–æ¶ˆ</button>
                    <button class="btn-primary" @click="createBranch">åˆ›å»º</button>
                </div>
            </div>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <div class="search-box">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="11" cy="11" r="8" stroke-width="2"/>
                    <path d="M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <input 
                    type="text" 
                    v-model="searchQuery" 
                    placeholder="æœç´¢å†å²è®°å½•..."
                    @input="filterRecords"
                />
            </div>
            <button class="toolbar-button" :class="{ 'active': showFilters }" @click="toggleFilters" title="ç­›é€‰">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="toolbar-button" @click="createSavePoint" title="åˆ›å»ºä¿å­˜ç‚¹">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" stroke-width="2"/>
                    <polyline points="17,21 17,13 7,13 7,21" stroke-width="2"/>
                    <polyline points="7,3 7,8 15,8" stroke-width="2"/>
                </svg>
            </button>
            <button class="toolbar-button" @click="expandAll" title="å±•å¼€å…¨éƒ¨">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M7 10l5 5 5-5" stroke-width="2" stroke-linecap="round"/>
                    <path d="M7 5l5 5 5-5" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="toolbar-button" @click="collapseAll" title="æŠ˜å å…¨éƒ¨">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M7 14l5-5 5 5" stroke-width="2" stroke-linecap="round"/>
                    <path d="M7 19l5-5 5 5" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="toolbar-button" @click="exportHistory" title="å¯¼å‡ºå†å²è®°å½•">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="toolbar-button" @click="showImport" title="å¯¼å…¥å†å²è®°å½•">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="toolbar-button" :class="{ 'active': compareMode }" @click="toggleCompareMode" title="æ¯”è¾ƒæ¨¡å¼">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="3" y="3" width="8" height="18" rx="1" stroke-width="2"/>
                    <rect x="13" y="3" width="8" height="18" rx="1" stroke-width="2"/>
                </svg>
            </button>
            <button class="toolbar-button" @click="restoreAll" title="æ¢å¤æ‰€æœ‰ç‰¹å¾">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M3 12a9 9 0 0114.5-7M21 12a9 9 0 01-14.5 7M3 4v5h5M21 20v-5h-5" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>

        <!-- æ¯”è¾ƒæ¨¡å¼æç¤ºæ  -->
        <div class="compare-bar" v-if="compareMode">
            <div class="compare-info">
                <span>ğŸ“Š æ¯”è¾ƒæ¨¡å¼ï¼šå·²é€‰æ‹© {{ selectedForCompare.length }}/2 æ¡è®°å½•</span>
            </div>
            <div class="compare-actions">
                <button class="compare-btn" @click="doCompare" :disabled="selectedForCompare.length !== 2">
                    å¼€å§‹æ¯”è¾ƒ
                </button>
                <button class="compare-cancel-btn" @click="exitCompareMode">
                    é€€å‡ºæ¯”è¾ƒ
                </button>
            </div>
        </div>

        <!-- å¯¼å…¥å¯¹è¯æ¡† -->
        <div class="modal-overlay" v-show="showImportDialog" @click.self="cancelImport">
            <div class="modal-content">
                <h3>ğŸ“¥ å¯¼å…¥å†å²è®°å½•</h3>
                <div class="form-group">
                    <label>é€‰æ‹©JSONæ–‡ä»¶</label>
                    <input type="file" accept=".json" @change="handleFileSelect" class="file-input"/>
                </div>
                <div class="import-warning">
                    âš ï¸ å¯¼å…¥å°†åˆå¹¶åˆ°å½“å‰å†å²è®°å½•ä¸­ï¼Œä¸ä¼šè¦†ç›–å·²æœ‰è®°å½•
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" @click="cancelImport">å–æ¶ˆ</button>
                    <button class="btn-primary" @click="doImport" :disabled="!importFile">å¯¼å…¥</button>
                </div>
            </div>
        </div>

        <!-- æ¯”è¾ƒç»“æœå¯¹è¯æ¡† -->
        <div class="modal-overlay compare-modal" v-show="showCompareDialog" @click.self="closeCompareDialog">
            <div class="modal-content compare-content">
                <h3>ğŸ“Š è®°å½•æ¯”è¾ƒç»“æœ</h3>
                <div class="compare-table" v-if="compareResult">
                    <div class="compare-header">
                        <div class="compare-cell header-cell">å­—æ®µ</div>
                        <div class="compare-cell header-cell">{{ compareResult.record1.name }}</div>
                        <div class="compare-cell header-cell">{{ compareResult.record2.name }}</div>
                    </div>
                    <div 
                        class="compare-row" 
                        v-for="diff in compareResult.differences" 
                        :key="diff.field"
                        :class="{ 'different': diff.isDifferent }"
                    >
                        <div class="compare-cell field-cell">{{ diff.field }}</div>
                        <div class="compare-cell value-cell">{{ diff.value1 }}</div>
                        <div class="compare-cell value-cell">{{ diff.value2 }}</div>
                    </div>
                </div>
                <div class="compare-summary" v-if="compareResult">
                    <span>å…± {{ compareResult.differences.filter(d => d.isDifferent).length }} å¤„å·®å¼‚</span>
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" @click="closeCompareDialog">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰é¢æ¿ -->
        <div class="filter-panel" v-show="showFilters">
            <div class="filter-section">
                <div class="filter-title">æ“ä½œç±»å‹</div>
                <div class="filter-options">
                    <label class="filter-checkbox" v-for="type in filterTypes" :key="type.value">
                        <input type="checkbox" v-model="type.checked" @change="filterRecords">
                        <span class="checkmark"></span>
                        <span class="filter-label">{{ type.icon }} {{ type.label }}</span>
                    </label>
                </div>
            </div>
            <div class="filter-section">
                <div class="filter-title">æ—¶é—´èŒƒå›´</div>
                <div class="filter-options time-range">
                    <button 
                        class="time-button" 
                        :class="{ 'active': timeRange === range.value }"
                        v-for="range in timeRanges" 
                        :key="range.value"
                        @click="setTimeRange(range.value)"
                    >
                        {{ range.label }}
                    </button>
                </div>
            </div>
            <div class="filter-actions">
                <button class="filter-clear" @click="clearFilters">æ¸…é™¤ç­›é€‰</button>
            </div>
        </div>

        <!-- è®°å½•æ•°é‡ç»Ÿè®¡ -->
        <div class="record-stats" v-if="filteredRecords.length > 0">
            <span>æ˜¾ç¤º {{ paginatedRecords.length }} / {{ filteredRecords.length }} æ¡è®°å½•</span>
        </div>

        <!-- å†å²è®°å½•æ—¶é—´è½´ -->
        <div class="timeline-container" @scroll="handleScroll">
            <div v-if="filteredRecords.length === 0" class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc">
                    <circle cx="12" cy="12" r="10" stroke-width="2"/>
                    <path d="M12 6v6l4 2" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p>{{ searchQuery ? 'æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•' : 'æš‚æ— å†å²è®°å½•' }}</p>
            </div>

            <div 
                v-for="(record, index) in paginatedRecords" 
                :key="record.id"
                class="timeline-item"
                :class="{ 
                    'important': record.isImportant,
                    'current-position': record.id === currentRollbackId,
                    'suppressed': record.isSuppressed,
                    'expanded': isExpanded(record),
                    'selected-for-compare': isSelectedForCompare(record),
                    [getRecordTypeClass(record)]: true
                }"
            >
                <div class="timeline-marker">
                    <!-- æ¯”è¾ƒæ¨¡å¼ä¸‹æ˜¾ç¤ºé€‰æ‹©æ¡† -->
                    <div v-if="compareMode" class="compare-checkbox" @click="toggleSelectForCompare(record, $event)">
                        <input type="checkbox" :checked="isSelectedForCompare(record)" />
                    </div>
                    <div v-else class="marker-dot" @click.stop="rollbackTo(record)" :title="'å›æº¯åˆ°æ­¤'"></div>
                    <div class="marker-line" v-if="index < paginatedRecords.length - 1"></div>
                </div>

                <div class="timeline-content" @click="compareMode ? toggleSelectForCompare(record, $event) : toggleExpand(record)">
                    <!-- ç®€åŒ–è§†å›¾ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
                    <div class="record-compact">
                        <div class="record-icon" :class="getTypeClass(record.featureType)">{{ getTypeIcon(record.type, record.featureType) }}</div>
                        <div class="record-brief">
                            <div class="record-name-row">
                                <span class="record-name">{{ record.name }}</span>
                                <span class="record-type-badge" :class="getRecordTypeClass(record)">{{ getRecordTypeIcon(record) }}</span>
                            </div>
                            <div class="record-meta-compact">
                                <span class="record-time">{{ formatTime(record.timestamp) }}</span>
                                <span class="record-type-label">{{ getTypeLabel(record.type, record.featureType) }}</span>
                            </div>
                        </div>
                        <!-- æ ‡ç­¾é¢„è§ˆ -->
                        <div class="tags-preview" v-if="record.tags && record.tags.length > 0">
                            <span 
                                class="tag-mini" 
                                v-for="tag in record.tags.slice(0, 2)" 
                                :key="tag"
                                :style="{ backgroundColor: getTagColor(tag) + '20', color: getTagColor(tag) }"
                            >{{ tag }}</span>
                            <span class="tag-more" v-if="record.tags.length > 2">+{{ record.tags.length - 2 }}</span>
                        </div>
                        <div class="expand-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" :transform="isExpanded(record) ? 'rotate(180 12 12)' : ''"/>
                            </svg>
                        </div>
                    </div>

                    <!-- å±•å¼€çš„è¯¦ç»†è§†å›¾ -->
                    <div class="record-details" v-show="isExpanded(record)">
                        <!-- è¯¦ç»†ä¿¡æ¯ -->
                        <div class="detail-section">
                            <div class="detail-row">
                                <span class="detail-label">ç‰¹å¾åç§°</span>
                                <span class="detail-value">{{ record.featureName || record.name }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">ç‰¹å¾ç±»å‹</span>
                                <span class="detail-value">{{ record.featureType || 'æœªçŸ¥' }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">æ“ä½œæ—¶é—´</span>
                                <span class="detail-value">{{ formatDateTime(record.timestamp) }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">ç‰¹å¾ç´¢å¼•</span>
                                <span class="detail-value">#{{ record.featureIndex }}</span>
                            </div>
                            <div class="detail-row" v-if="record.description">
                                <span class="detail-label">æè¿°</span>
                                <span class="detail-value">{{ record.description }}</span>
                            </div>
                        </div>

                        <!-- æ ‡ç­¾åŒºåŸŸ -->
                        <div class="tags-section">
                            <div class="section-header">
                                <span class="section-title">ğŸ·ï¸ æ ‡ç­¾</span>
                                <button class="add-tag-btn" @click="startEditTags(record, $event)" v-if="editingTagsId !== record.id">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <line x1="12" y1="5" x2="12" y2="19" stroke-width="2"/>
                                        <line x1="5" y1="12" x2="19" y2="12" stroke-width="2"/>
                                    </svg>
                                    æ·»åŠ 
                                </button>
                            </div>
                            <div class="tags-container">
                                <span 
                                    class="tag" 
                                    v-for="tag in (record.tags || [])" 
                                    :key="tag"
                                    :style="{ backgroundColor: getTagColor(tag) + '20', color: getTagColor(tag), borderColor: getTagColor(tag) }"
                                >
                                    {{ tag }}
                                    <button class="tag-remove" @click="removeTag(record, tag, $event)">Ã—</button>
                                </span>
                                <span class="no-tags" v-if="!record.tags || record.tags.length === 0">æš‚æ— æ ‡ç­¾</span>
                            </div>
                            <!-- æ·»åŠ æ ‡ç­¾è¾“å…¥ -->
                            <div class="tag-input-row" v-if="editingTagsId === record.id">
                                <input 
                                    type="text" 
                                    v-model="newTagText" 
                                    placeholder="è¾“å…¥æ ‡ç­¾åç§°" 
                                    @keyup.enter="addTag(record, $event)"
                                    @click.stop
                                    class="tag-input"
                                />
                                <button class="tag-add-btn" @click="addTag(record, $event)">æ·»åŠ </button>
                                <button class="tag-cancel-btn" @click="closeTagEdit($event)">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <!-- æ³¨é‡ŠåŒºåŸŸ -->
                        <div class="note-section">
                            <div class="section-header">
                                <span class="section-title">ğŸ“ æ³¨é‡Š</span>
                                <button class="edit-note-btn" @click="startEditNote(record, $event)" v-if="editingNoteId !== record.id">
                                    {{ record.userNote ? 'ç¼–è¾‘' : 'æ·»åŠ ' }}
                                </button>
                            </div>
                            <div class="note-content" v-if="editingNoteId !== record.id">
                                <p v-if="record.userNote">{{ record.userNote }}</p>
                                <p class="no-note" v-else>æš‚æ— æ³¨é‡Šï¼Œç‚¹å‡»æ·»åŠ </p>
                            </div>
                            <div class="note-edit" v-else @click.stop>
                                <textarea 
                                    v-model="editingNoteText" 
                                    placeholder="è¾“å…¥è®¾è®¡å†³ç­–ã€æ€è·¯æˆ–å¤‡æ³¨..."
                                    rows="3"
                                    class="note-textarea"
                                ></textarea>
                                <div class="note-actions">
                                    <button class="note-save-btn" @click="saveNote(record, $event)">ä¿å­˜</button>
                                    <button class="note-cancel-btn" @click="cancelEditNote($event)">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="record-actions-expanded">
                            <button class="action-btn rollback-btn" @click.stop="rollbackTo(record)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M3 12a9 9 0 0114.5-7M21 12a9 9 0 01-14.5 7M3 4v5h5M21 20v-5h-5" stroke-width="2"/>
                                </svg>
                                å›æº¯åˆ°æ­¤
                            </button>
                            <button 
                                class="action-btn star-btn" 
                                :class="{ 'active': record.isImportant }"
                                @click.stop="toggleImportant(record)"
                            >
                                â­ {{ record.isImportant ? 'å–æ¶ˆé‡è¦' : 'æ ‡è®°é‡è¦' }}
                            </button>
                            <button class="action-btn delete-btn" @click.stop="deleteRecord(record)">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
            <div class="load-more" v-if="hasMoreRecords">
                <button class="load-more-btn" @click="loadMore">
                    åŠ è½½æ›´å¤š ({{ filteredRecords.length - paginatedRecords.length }} æ¡)
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="history.js"></script>
</body>
</html>