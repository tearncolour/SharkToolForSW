<template>
  <div class="git-control">
    <div class="git-header">
      <h3>Git 版本控制</h3>
      <a-space>
        <a-button size="small" @click="refreshStatus" :loading="loading">
          <template #icon><ReloadOutlined /></template>
        </a-button>
      </a-space>
    </div>

    <div v-if="!gitToken" class="auth-warning">
      <a-alert
        message="未登录 GitHub"
        description="请在 SolidWorks 插件中登录 GitHub 以启用同步功能。"
        type="warning"
        show-icon
      />
    </div>

    <div v-if="!isGitRepo" class="no-repo">
      <a-empty description="当前目录不是 Git 仓库" />
      <div class="repo-actions" v-if="currentPath">
        <a-button type="primary" @click="initRepo">初始化仓库</a-button>
      </div>
    </div>

    <div v-else class="repo-content">
      <div class="branch-info">
        <BranchesOutlined />
        <span class="branch-name">{{ currentBranch }}</span>
      </div>

      <div class="actions-bar">
        <a-space>
          <a-button @click="pull" :loading="pulling">
            <template #icon><CloudDownloadOutlined /></template>
            拉取
          </a-button>
          <a-button type="primary" @click="push" :loading="pushing">
            <template #icon><CloudUploadOutlined /></template>
            推送
          </a-button>
        </a-space>
      </div>

      <div class="changes-section">
        <h4>更改 ({{ changes.length }})</h4>
        <div class="changes-list">
          <div v-for="(file, index) in changes" :key="index" class="change-item">
            <span class="change-status" :class="file.status">{{ file.status }}</span>
            <span class="change-path" :title="file.path">{{ file.path }}</span>
          </div>
          <div v-if="changes.length === 0" class="no-changes">
            无更改
          </div>
        </div>
      </div>

      <div class="commit-section" v-if="changes.length > 0">
        <a-textarea
          v-model:value="commitMessage"
          placeholder="提交信息..."
          :rows="2"
          class="commit-input"
        />
        <a-button 
          type="primary" 
          block 
          @click="commit" 
          :disabled="!commitMessage"
          :loading="committing"
        >
          提交更改
        </a-button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, watch } from 'vue';
import { 
  ReloadOutlined, 
  BranchesOutlined, 
  CloudDownloadOutlined, 
  CloudUploadOutlined 
} from '@ant-design/icons-vue';
import { message } from 'ant-design-vue';

const props = defineProps({
  currentPath: {
    type: String,
    default: ''
  }
});

const loading = ref(false);
const pulling = ref(false);
const pushing = ref(false);
const committing = ref(false);
const isGitRepo = ref(false);
const currentBranch = ref('');
const changes = ref([]);
const commitMessage = ref('');
const gitToken = ref(null);

// 监听路径变化，重新加载 Git 状态
watch(() => props.currentPath, (newPath) => {
  if (newPath) {
    refreshStatus();
  }
});

onMounted(async () => {
  await checkAuth();
  if (props.currentPath) {
    refreshStatus();
  }
});

const checkAuth = async () => {
  try {
    const token = await window.electronAPI.gitGetToken();
    gitToken.value = token;
  } catch (e) {
    console.error('Failed to get git token', e);
  }
};

const refreshStatus = async () => {
  await checkAuth();
  if (!props.currentPath) return;
  
  loading.value = true;
  try {
    const result = await window.electronAPI.gitStatus(props.currentPath);
    if (result && result.isRepo) {
      isGitRepo.value = true;
      currentBranch.value = result.branch;
      
      // 直接使用后端返回的 files 数组
      changes.value = result.files.map(f => ({
        status: f.code.trim(),
        path: f.file
      }));
    } else {
      isGitRepo.value = false;
      changes.value = [];
    }
  } catch (e) {
    isGitRepo.value = false;
  } finally {
    loading.value = false;
  }
};

const pull = async () => {
  pulling.value = true;
  try {
    await window.electronAPI.gitPull(props.currentPath);
    message.success('拉取成功');
    refreshStatus();
  } catch (e) {
    message.error('拉取失败: ' + (e.stderr || e.message));
  } finally {
    pulling.value = false;
  }
};

const push = async () => {
  pushing.value = true;
  try {
    await window.electronAPI.gitPush(props.currentPath);
    message.success('推送成功');
  } catch (e) {
    message.error('推送失败: ' + (e.stderr || e.message));
  } finally {
    pushing.value = false;
  }
};

const commit = async () => {
  if (!commitMessage.value) return;
  
  committing.value = true;
  try {
    // 传递空数组以暂存所有更改 (git add .)
    await window.electronAPI.gitAdd(props.currentPath, []);
    await window.electronAPI.gitCommit(props.currentPath, commitMessage.value);
    message.success('提交成功');
    commitMessage.value = '';
    refreshStatus();
  } catch (e) {
    message.error('提交失败: ' + (e.stderr || e.message));
  } finally {
    committing.value = false;
  }
};

const initRepo = async () => {
  try {
    await window.electronAPI.gitInit(props.currentPath);
    message.success('仓库初始化成功 (.gitignore 已创建)');
    refreshStatus();
  } catch (e) {
    message.error('初始化失败');
  }
};
</script>

<style scoped>
.git-control {
  padding: 16px;
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #1e1e1e;
  color: #cccccc;
}

.git-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid #3c3c3c;
}

.git-header h3 {
  margin: 0;
  font-size: 16px;
  color: #ffffff;
}

.auth-warning {
  margin-bottom: 16px;
}

.no-repo {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
}

.repo-actions {
  margin-top: 16px;
}

.repo-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.branch-info {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  margin-bottom: 16px;
  color: #40a9ff;
  font-weight: 500;
}

.actions-bar {
  margin-bottom: 16px;
}

.changes-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  margin-bottom: 16px;
}

.changes-section h4 {
  margin-bottom: 8px;
  font-size: 13px;
  color: #aaaaaa;
}

.changes-list {
  flex: 1;
  overflow-y: auto;
  border: 1px solid #3c3c3c;
  background-color: #252526;
  border-radius: 4px;
  padding: 8px;
}

.change-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 12px;
  color: #cccccc;
}

.change-item:hover {
  background-color: #2a2d2e;
}

.change-status {
  font-family: monospace;
  font-weight: bold;
  width: 20px;
  text-align: center;
}

.change-status.M { color: #faad14; }
.change-status.A { color: #52c41a; }
.change-status.D { color: #ff4d4f; }
.change-status.\?\? { color: #1890ff; }

.change-path {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.no-changes {
  color: #888;
  text-align: center;
  padding: 16px;
  font-size: 12px;
}

.commit-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.commit-input {
  resize: none;
}

/* Ant Design Dark Mode Overrides */
:deep(.ant-btn) {
  background-color: #3c3c3c;
  border-color: #3c3c3c;
  color: #cccccc;
}
:deep(.ant-btn:hover) {
  background-color: #4c4c4c;
  border-color: #4c4c4c;
  color: #ffffff;
}
:deep(.ant-btn-primary) {
  background-color: #007acc;
  border-color: #007acc;
  color: #ffffff;
}
:deep(.ant-btn-primary:hover) {
  background-color: #0098ff;
  border-color: #0098ff;
}
:deep(.ant-input), :deep(.ant-input-textarea) {
  background-color: #252526;
  border-color: #3c3c3c;
  color: #cccccc;
}
:deep(.ant-empty-description) {
  color: #aaaaaa;
}
</style>